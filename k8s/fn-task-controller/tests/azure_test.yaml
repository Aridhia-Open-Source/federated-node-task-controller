suite: Storage testing for Azure
release:
  namespace: federatednode
  name: federatednode
values:
  - values/base-values.yaml
set:
  storage:
    azure:
      secretName: azure-secret
      storageAccountName: account
      storageAccountKey: keysecret
      shareName: files
    local:
kubernetesProvider:
  scheme:
    v1/Secret:
      gvr:
        version: v1
        resource: secrets
      namespaced: true
    v1/ConfigMap:
      gvr:
        version: v1
        resource: configmaps
      namespaced: true
  objects:
    - apiVersion: v1
      kind: Secret
      metadata:
        name: github-app
        namespace: federatednode
      type: Opaque
      data:
        GH_SECRET: dGVzdA==
        GH_CLIENT_ID: dGVzdA==
    - apiVersion: v1
      kind: Secret
      metadata:
        name: kc-secrets
        namespace: federatednode
      data:
        GH_SECRET: dGVzdA==
        GH_CLIENT_ID: dGVzdA==
    - apiVersion: v1
      kind: Secret
      metadata:
        name: azure-secret
        namespace: federatednode
      data:
        EMAIL_CERT: dGVzdA==
        REGION: dGVzdA==
        ACCOUNT_ID: dGVzdA==
        ROLE_NAME: dGVzdA==
    - apiVersion: v1
      kind: ConfigMap
      metadata:
        name: keycloak-config
        namespace: federatednode
      data:
        GH_SECRET: dGVzdA==
        GH_CLIENT_ID: dGVzdA==
tests:
  - it: creates Azure storage
    template: storageclass.yaml
    asserts:
      - equal:
          path: provisioner
          value: disk.csi.azure.com
      - equal:
          path: parameters.skuname
          value: Premium_LRS
  - it: creates Azure PV(C)
    template: controller-volumes.yaml
    documentSelector:
      path: kind
      value: PersistentVolume
    asserts:
      - equal:
          path: spec.azureFile.shareName
          value: files
      - equal:
          path: spec.azureFile.readOnly
          value: false
      - equal:
          path: spec.azureFile.secretName
          value: azure-secret
  - it: creates Azure configmap
    template: controller-configmap.yaml
    asserts:
      - equal:
          path: data["AZURE_STORAGE_ENABLED"]
          value: "true"
      - equal:
          path: data["AZURE_SHARE_NAME"]
          value: files/controller
      - equal:
          path: data["AZURE_SECRET_NAME"]
          value: azure-secret
